<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: components/axis/xAxis.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: components/axis/xAxis.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>// xAxis.js
// Timeline that lurks down below

import Axis from "./axis";
import { MAXGRADSPER } from "../../definitions/chart";
import { isNumber } from "../../utils/typeChecks";
import { round } from "../../utils/number"
import { 
  ms2TimeUnits, timestampDifference,
  isLeapYear, year_start, get_year, nextYear,
  month_start, get_month, get_monthName, nextMonth,
  get_day, day_start, get_dayName,
  get_hour, hour_start,
  get_minute, minute_start,
  get_second, second_start,
  buildSubGrads,

  SECOND_MS, MINUTE_MS, HOUR_MS, DAY_MS, WEEK_MS, MONTH_MS, MONTHR_MS, YEAR_MS,
 } from "../../utils/time";
import { XAxisStyle } from "../../definitions/style";

export default class xAxis extends Axis {

  #xAxisTicks = 4
  #xAxisGrads
  #xAxisSubGrads

  constructor(parent, chart) {
    super(parent, chart)

    this.#xAxisSubGrads = buildSubGrads()
  }

  get chart() { return this.parent.mediator.api.Chart }
  get core() { return this.chart.core }
  get data() { return this.chart.data }
  get range() { return this.parent.range }
  get width() { return this.calcWidth() }
  get interval() { return this.range.interval }
  get intervalStr() { return this.range.intervalStr }
  get timeStart() { return this.range.timeStart }
  get timeFinish() { return this.range.timeFinish }
  get rangeDuration() { return this.range.rangeDuration }
  get rangeLength() { return this.range.Length }
  get indexStart() { return this.range.indexStart }
  get indexEnd() { return this.range.indexEnd }
  get timeMax() { return this.range.timeMax }
  get timeMin() { return this.range.timeMin }
  get candleW() { return round(this.width / this.range.Length, 1) }
  get gradsMax() { return Math.trunc(this.width / MAXGRADSPER) }
      gradsYear(t) { return get_year(t) }
      gradsMonthName(t) { return get_monthName(t) }
      gradsDayName(t) { return get_dayName(t) +" "+ get_day(t) }
      gradsHour(t) { return get_hour(t) + ":00" }
      gradsMinute(t) { return "00:" + get_minute(t) }
  get xAxisRatio() { return this.width / this.range.rangeDuration }
  set xAxisTicks(t) { this.#xAxisTicks = isNumber(t) ? t : 0 }
  get xAxisTicks() { return this.#xAxisTicks }
  get xAxisGrads() { return this.#xAxisGrads }
  get xAxisSubGrads() { return this.#xAxisSubGrads }
  get scrollOffsetPx() { return this.core.scrollPos % this.candleW }
  get bufferPx() { return this.core.bufferPx }

  calcWidth() {
    return this.core.Chart.width - this.core.Chart.scale.width
  }

  /**
 * return canvas x co-ordinate
 * handles X Axis modes: default, indexed
 * @param {number} ts - chart time stamp
 * @return {number}  
 * @memberof xAxis
 */
  xPos(ts) {
    return (this.range.rangeIndex(ts) * this.candleW) + (this.candleW * 0.5)
  }

  t2Pixel(ts) {
    return this.xPos(ts)
  }

  pixel2T(x) {
    let c = this.pixel2Index(x)
    return this.range.value(c)[0]
  }

  pixel2Index(x) {
    let o = this.core.rangeScrollOffset;
    let c = this.range.indexStart - o 
    return c + 1
      + Math.floor((x + (this.core.scrollPos * -1)) / this.candleW) 
  }

  pixelOHLCV(x) {
    let c = this.pixel2Index(x)
    return this.range.value(c)
  }

  xPosSnap2CandlePos(x) {
    let r = this.core.scrollPos % this.candleW
    // let o = (x % this.candleW &lt; this.candleW / 2) ? this.candleW : this.candleW * -1
    let c = Math.floor((x / this.candleW)) // + o
    return  (c * this.candleW) + (this.candleW / 2) // + o

    // return ((this.pixel2Index(x) - this.range.indexStart) 
    //         * this.candleW) - (this.candleW / 2)
  }

  /**
   * return chart time
   * handles X Axis modes: default, indexed
   * @param {number} x
   * @returns {timestamp}
   * @memberof xAxis
   */
  xPos2Time(x) {
    return this.pixel2T(x)
  }

  xPos2Index(x) {
    return this.pixel2Index(x)
  }

  xPosOHLCV(x) {
    return this.pixelOHLCV(x)
  }

  initXAxisGrads() {
    this.#xAxisGrads = this.calcXAxisGrads()
  }

  calcXAxisGrads() {
    const rangeStart = this.timeMin
    const rangeEnd = this.timeMax
    const intervalStr = this.intervalStr
    const grads = {
      entries: {},
      values: [],
      major: [],
      minor: []
    }
    const unit = intervalStr.charAt(intervalStr.length - 1)
    const numUnits = parseInt(intervalStr, 10)

// return grads

      let days, t1, t2, units, unitStart, 
          majorGrad, majorValue, minorValue;
    
      units = ms2TimeUnits(this.rangeDuration)
      grads.units = ms2TimeUnits(this.rangeDuration)
    
    // Years
    if (units.years > 0) {
            
      t1 = year_start(rangeStart)
      t2 = nextYear(year_start(rangeEnd)) + YEAR_MS

      grads.unit = ["y", "year"]
      grads.timeSpan = `${units.years} years`

      majorGrad = (ts) => { return nextYear(ts) }

      unitStart = (ts) => { return month_start(ts) }

      majorValue = (ts) => { 
        return get_year(ts) 
      }
      minorValue = (ts) => { 
        if (get_month(ts) == 0 &amp;&amp; get_day(ts) == 1 &amp;&amp; get_hour(ts) == 0) return get_year(ts)
        else return get_monthName(ts) 
      }

      return this.buildGrads(grads, t1, t2, majorGrad, majorValue, minorValue, unitStart)
    }
      
    // Months
    else if (units.months > 0) {

      t1 = month_start(rangeStart)
      t2 = month_start(rangeEnd) + MONTH_MS(get_month(rangeEnd))// + YEAR_MS

      grads.unit = ["M", "month"]
      grads.timeSpan = `${units.months} months`

      // TODO: optimize nextMonth() - too slow on large rages
      // majorGrad = (ts) => { return nextMonth(ts) }
      majorGrad = (ts) => { return MONTHR_MS }

      unitStart = (ts) => { return day_start(ts) }

      majorValue = (ts) => { 
        if (get_month(ts) == 0) return get_year(ts)
        else return get_monthName(ts)
      }
      minorValue = (ts) => {
        if (get_month(ts) == 0 &amp;&amp; get_day(ts) == 1) return get_year(ts)
        if (get_day(ts) == 1 &amp;&amp; get_hour(ts) == 0) return get_monthName(ts)
        else return this.gradsDayName(ts) 
      }

      return this.buildGrads(grads, t1, t2, majorGrad, majorValue, minorValue, unitStart)
    }
    
    // Days
    else if (units.weeks > 0 || units.days > 0) {
      days = units.weeks * 7 + units.days

      t1 = day_start(rangeStart)
      t2 = day_start(rangeEnd) + WEEK_MS

      grads.unit = ["d", "day"]
      grads.timeSpan = `${days} days`

      majorGrad = (ts) => { return DAY_MS }

      unitStart = (ts) => { return hour_start(ts) }

      majorValue = (ts) => { 
        if (get_month(ts) == 0 &amp;&amp; get_day(ts) == 1) return get_year(ts)
        else if (get_day(ts) == 1) return get_monthName(ts)
        else return this.gradsDayName(ts) // null
      }
      minorValue = (ts) => { 
        if (get_day(ts) == 1 &amp;&amp; get_hour(ts) == 0) return get_monthName(ts)
        else if (get_hour(ts) == 0) return this.gradsDayName(ts)
        else return get_hour(ts) + ":00" 
      }

      return this.buildGrads(grads, t1, t2, majorGrad, majorValue, minorValue, unitStart)
    }
    
    // Hours
    else if (units.hours > 0) {
      
      t1 = hour_start(rangeStart)
      t2 = hour_start(rangeEnd) + DAY_MS

      grads.unit = ["h", "hour"]
      grads.timeSpan = `${units.hours} hours`

      majorGrad = (ts) => { return HOUR_MS }
        
      unitStart = (ts) => { return minute_start(ts) }

      majorValue = (ts) => {
        if (get_month(ts) == 0 &amp;&amp; get_day(ts) == 1 &amp;&amp; get_hour(ts) == 0) return get_year(ts)
        else if (get_day(ts) == 1 &amp;&amp; get_hour(ts) == 0) return get_monthName(ts)
        else if (get_hour(ts) == 0) return this.gradsDayName(ts)
        else return this.HM(ts)
      }
      minorValue = (ts) => { return this.HM(ts) }

      return this.buildGrads(grads, t1, t2, majorGrad, majorValue, minorValue, unitStart)
    }
    
    // Minutes
    else if (units.minutes > 0) {
      
      t1 = minute_start(rangeStart)
      t2 = minute_start(rangeEnd) + HOUR_MS

      grads.unit = ["m", "minute"]
      grads.timeSpan = `${units.minutes} minutes`

      majorGrad = (ts) => { return MINUTE_MS }

      unitStart = (ts) => { return second_start(ts) }

      majorValue = (ts) => {
        if (get_month(ts) == 0 &amp;&amp; get_day(ts) == 1 &amp;&amp; get_hour(ts) == 0 &amp;&amp; get_minute(ts) == 0) return get_year(ts)
        else if (get_day(ts) == 1 &amp;&amp; get_hour(ts) == 0 &amp;&amp; get_minute(ts) == 0) return get_monthName(ts)
        else if (get_hour(ts) == 0 &amp;&amp; get_minute(ts) == 0) return this.gradsDayName(ts)
        else return this.HM(ts)
      }
      minorValue = (ts) => { return this.HMS(ts) }

      return this.buildGrads(grads, t1, t2, majorGrad, majorValue, minorValue, unitStart)
    }

    // Seconds
    else if (units.seconds > 0) {
      
      t1 = second_start(rangeStart) - MINUTE_MS
      t2 = second_start(rangeEnd) + MINUTE_MS

      grads.unit = ["s", "second"]
      grads.timeSpan = `${units.seconds} seconds`

      majorGrad = (ts) => { return SECOND_MS }
        
      unitStart = (ts) => { return second_start(ts) }

      majorValue = (ts) => {
        if (get_month(ts) == 0 &amp;&amp; get_day(ts) == 1 &amp;&amp; get_hour(ts) == 0 &amp;&amp; get_minute(ts) == 0) return get_year(ts)
        else if (get_day(ts) == 1 &amp;&amp; get_hour(ts) == 0 &amp;&amp; get_minute(ts) == 0) return get_monthName(ts)
        else if (get_hour(ts) == 0 &amp;&amp; get_minute(ts) == 0) return this.gradsDayName(ts)
        else if (get_minute(ts) == 0 &amp;&amp; get_second(ts) == 0) return this.HM(ts)
        else return this.MS(ts)
      }
      minorValue = (ts) => { return this.MS(ts) }

      return this.buildGrads(grads, t1, t2, majorGrad, majorValue, minorValue, unitStart)
    }
  }

  buildGrads(grads, t1, t2, majorGrad ,majorValue, minorValue, unitStart) {
    let th, to, min;
    const minorGrad = Math.floor(this.rangeLength / this.gradsMax) * this.range.interval

    while (t1 &lt; t2) {
      to = t1
      grads.entries[t1] = [majorValue(t1), this.t2Pixel(t1), t1, "major"]

      th = t1
      t1 += majorGrad(t1)

      while ((t1 - to) &lt; minorGrad) {
        t1 += majorGrad(t1)
      }

      let x = Math.floor((t1 - to) / minorGrad)
      if (x > 0 ) {
        let y = Math.floor((t1 - to) / x)
        while (th &lt; t1) {
          th += y
          min = unitStart(th)
          grads.entries[min] = [minorValue(min), this.t2Pixel(min), min, "minor"]
        }
      }
    }

    grads.values = Object.values(grads.entries)

    return grads
  }

  gradsWorker() {
    
  }

  HM(t) {
    let h = String(get_hour(t)).padStart(2, '0');
    let m = String(get_minute(t)).padStart(2, '0');
    return `${h}:${m}`
  }

  HMS(t) {
    let h = String(get_hour(t)).padStart(2, '0');
    let m = String(get_minute(t)).padStart(2, '0');
    let s = String(get_second(t)).padStart(2, '0');
    return `${h}:${m}:${s}`
  }

  MS(t) {
    let m = String(get_minute(t)).padStart(2, '0');
    let s = String(get_second(t)).padStart(2, '0');
    return `${m}:${s}`
  }

  draw() {
    this.#xAxisGrads = this.calcXAxisGrads()
    this.drawGrads()
    this.drawOverlays()
  }

  drawGrads() {
    this.parent.layerLabels.scene.clear()

    const grads = this.#xAxisGrads.values
    const ctx = this.parent.layerLabels.scene.context
    const mid = this.width / this.range.Length * 0.5
    const offset = 0


    ctx.save();
    ctx.strokeStyle = XAxisStyle.COLOUR_TICK
    ctx.fillStyle = XAxisStyle.COLOUR_TICK
    ctx.font = XAxisStyle.FONT_LABEL
    for (let tick of grads) { 
      // ctx.font = (tick[3] == "major") ? XAxisStyle.FONT_LABEL_BOLD : XAxisStyle.FONT_LABEL
      let w = Math.floor(ctx.measureText(`${tick[0]}`).width * 0.5)
      ctx.fillText(tick[0], tick[1] - w + offset, this.xAxisTicks + 12)

      ctx.beginPath()
      ctx.moveTo(tick[1] + offset, 0)
      ctx.lineTo(tick[1] + offset, this.xAxisTicks)
      ctx.stroke()
    }
      ctx.restore();
  }

  drawOverlays() {
    this.parent.layerOverlays.scene.clear()

    const grads = this.#xAxisGrads
  }

}
</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Classes</h3><ul><li><a href="Axis.html">Axis</a></li><li><a href="Colour.html">Colour</a></li><li><a href="DMI.module.exports.html">module.exports</a></li><li><a href="Hit.html">Hit</a></li><li><a href="indicator.html">indicator</a></li><li><a href="Layer.html">Layer</a></li><li><a href="MainPane.html">MainPane</a></li><li><a href="module.exports_module.exports.html">exports</a></li><li><a href="RSI.html">RSI</a></li><li><a href="RSI.module.exports.html">module.exports</a></li><li><a href="ScaleBar.html">ScaleBar</a></li><li><a href="Scene.html">Scene</a></li><li><a href="StateMachine.html">StateMachine</a></li><li><a href="ToolsBar.html">ToolsBar</a></li><li><a href="TradeXchart.html">TradeXchart</a></li><li><a href="TradeXchart.module.exports.html">module.exports</a></li><li><a href="Viewport.html">Viewport</a></li><li><a href="WebWorker.html">WebWorker</a></li></ul><h3>Global</h3><ul><li><a href="global.html#addOffChart">addOffChart</a></li><li><a href="global.html#addTool">addTool</a></li><li><a href="global.html#binarySearch">binarySearch</a></li><li><a href="global.html#binarySearchNearest">binarySearchNearest</a></li><li><a href="global.html#calcIndicator">calcIndicator</a></li><li><a href="global.html#calcIndicatorStream">calcIndicatorStream</a></li><li><a href="global.html#calcTextWidth">calcTextWidth</a></li><li><a href="global.html#calcTimeIndex">calcTimeIndex</a></li><li><a href="global.html#CandleType">CandleType</a></li><li><a href="global.html#checkType">checkType</a></li><li><a href="global.html#copyDeep">copyDeep</a></li><li><a href="global.html#countDigits">countDigits</a></li><li><a href="global.html#createFont">createFont</a></li><li><a href="global.html#day_start">day_start</a></li><li><a href="global.html#decimalPlaces">decimalPlaces</a></li><li><a href="global.html#destroy">destroy</a></li><li><a href="global.html#detectInterval">detectInterval</a></li><li><a href="global.html#draw">draw</a></li><li><a href="global.html#drawTextBG">drawTextBG</a></li><li><a href="global.html#emit">emit</a></li><li><a href="global.html#end">end</a></li><li><a href="global.html#execute">execute</a></li><li><a href="global.html#float2Int">float2Int</a></li><li><a href="global.html#get_day">get_day</a></li><li><a href="global.html#get_month">get_month</a></li><li><a href="global.html#get_year">get_year</a></li><li><a href="global.html#getPixelRatio">getPixelRatio</a></li><li><a href="global.html#getPrecision">getPrecision</a></li><li><a href="global.html#getRandom">getRandom</a></li><li><a href="global.html#getRandomInt">getRandomInt</a></li><li><a href="global.html#getRandomIntBetween">getRandomIntBetween</a></li><li><a href="global.html#getRandomIntInclusive">getRandomIntInclusive</a></li><li><a href="global.html#getRange">getRange</a></li><li><a href="global.html#getTextRectHeight">getTextRectHeight</a></li><li><a href="global.html#getTextRectWidth">getTextRectWidth</a></li><li><a href="global.html#GlobalStyle">GlobalStyle</a></li><li><a href="global.html#hex">hex</a></li><li><a href="global.html#hexa">hexa</a></li><li><a href="global.html#id">id</a></li><li><a href="global.html#index10">index10</a></li><li><a href="global.html#init">init</a></li><li><a href="global.html#interval2MS">interval2MS</a></li><li><a href="global.html#isArray">isArray</a></li><li><a href="global.html#isBoolean">isBoolean</a></li><li><a href="global.html#isFunction">isFunction</a></li><li><a href="global.html#isNumber">isNumber</a></li><li><a href="global.html#isObject">isObject</a></li><li><a href="global.html#isString">isString</a></li><li><a href="global.html#isValid">isValid</a></li><li><a href="global.html#isValidCandle">isValidCandle</a></li><li><a href="global.html#limit">limit</a></li><li><a href="global.html#loadState">loadState</a></li><li><a href="global.html#log10">log10</a></li><li><a href="global.html#maxMinPriceVol">maxMinPriceVol</a></li><li><a href="global.html#mean">mean</a></li><li><a href="global.html#mergeData">mergeData</a></li><li><a href="global.html#mergeDeep">mergeDeep</a></li><li><a href="global.html#month_start">month_start</a></li><li><a href="global.html#ms2TimeUnits">ms2TimeUnits</a></li><li><a href="global.html#nearestArrayValue">nearestArrayValue</a></li><li><a href="global.html#nice">nice</a></li><li><a href="global.html#numDigits">numDigits</a></li><li><a href="global.html#numDigits2">numDigits2</a></li><li><a href="global.html#off">off</a></li><li><a href="global.html#on">on</a></li><li><a href="global.html#power">power</a></li><li><a href="global.html#precision">precision</a></li><li><a href="global.html#price2YPos">price2YPos</a></li><li><a href="global.html#refresh">refresh</a></li><li><a href="global.html#renderClosedFillPath">renderClosedFillPath</a></li><li><a href="global.html#renderClosedStrokePath">renderClosedStrokePath</a></li><li><a href="global.html#renderFilledCircle">renderFilledCircle</a></li><li><a href="global.html#renderFilledDiamond">renderFilledDiamond</a></li><li><a href="global.html#renderFilledTriangle">renderFilledTriangle</a></li><li><a href="global.html#renderFillRect">renderFillRect</a></li><li><a href="global.html#renderFillRoundRect">renderFillRoundRect</a></li><li><a href="global.html#renderHorizontalLine">renderHorizontalLine</a></li><li><a href="global.html#renderLine">renderLine</a></li><li><a href="global.html#renderPath">renderPath</a></li><li><a href="global.html#renderRoundRect">renderRoundRect</a></li><li><a href="global.html#renderStrokedCircle">renderStrokedCircle</a></li><li><a href="global.html#renderStrokeFillRoundRect">renderStrokeFillRoundRect</a></li><li><a href="global.html#renderStrokeRoundRect">renderStrokeRoundRect</a></li><li><a href="global.html#renderText">renderText</a></li><li><a href="global.html#renderVerticalLine">renderVerticalLine</a></li><li><a href="global.html#resize">resize</a></li><li><a href="global.html#round">round</a></li><li><a href="global.html#saveState">saveState</a></li><li><a href="global.html#setDimensions">setDimensions</a></li><li><a href="global.html#setPricePrecision">setPricePrecision</a></li><li><a href="global.html#setPriceVolumePrecision">setPriceVolumePrecision</a></li><li><a href="global.html#setRange">setRange</a></li><li><a href="global.html#setStream">setStream</a></li><li><a href="global.html#setTheme">setTheme</a></li><li><a href="global.html#setVolumePrecision">setVolumePrecision</a></li><li><a href="global.html#start">start</a></li><li><a href="global.html#stop">stop</a></li><li><a href="global.html#time2XPos">time2XPos</a></li><li><a href="global.html#timestampDifference">timestampDifference</a></li><li><a href="global.html#updateLegends">updateLegends</a></li><li><a href="global.html#updateRange">updateRange</a></li><li><a href="global.html#validateConfig">validateConfig</a></li><li><a href="global.html#validateShallow">validateShallow</a></li><li><a href="global.html#value">value</a></li><li><a href="global.html#weave">weave</a></li><li><a href="global.html#YAxisPosition">YAxisPosition</a></li><li><a href="global.html#YAxisType">YAxisType</a></li><li><a href="global.html#year_start">year_start</a></li><li><a href="global.html#zoomRange">zoomRange</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc/jsdoc">JSDoc 3.6.11</a> on Tue Oct 18 2022 01:23:08 GMT+0200 (Central European Summer Time)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
