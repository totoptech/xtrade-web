<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: components/axis/xAxis.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: components/axis/xAxis.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>// xAxis.js
// Timeline that lurks down below

import Axis from "./axis";
import { XAXIS_STEP } from "../../definitions/chart";
import { isNumber } from "../../utils/typeChecks";
import { bRound } from "../../utils/number"
import { 
  ms2TimeUnits,
  get_year,
  get_month, get_monthName,
  get_day,
  get_hour,
  get_minute,
  get_second,
  buildSubGrads, time_start,

  TIMESCALES, TIMESCALESRANK,
  MINUTE_MS, HOUR_MS, DAY_MS,
 } from "../../utils/time";

export default class xAxis extends Axis {

  #xAxisTicks = 4
  #xAxisGrads
  #indexBased = true

  constructor(parent) {
    super(parent)
  }

  get range() { return this.parent.range }
  get width() { return this.parent.width }
  get interval() { return this.range.interval }
  get intervalStr() { return this.range.intervalStr }
  get timeStart() { return this.range.timeStart }
  get timeFinish() { return this.range.timeFinish }
  get rangeDuration() { return this.range.rangeDuration }
  get rangeLength() { return this.range.Length }
  get indexStart() { return this.range.indexStart }
  get indexEnd() { return this.range.indexEnd }
  get timeMax() { return this.range.timeMax }
  get timeMin() { return this.range.timeMin }
  get candleW() { return bRound(this.width / this.range.Length) }
  get candlesOnLayer() { return bRound(this.core.Chart.layerWidth / this.candleW )}
  get xAxisRatio() { return this.width / this.range.rangeDuration }
  set xAxisTicks(t) { this.#xAxisTicks = isNumber(t) ? t : 0 }
  get xAxisTicks() { return this.#xAxisTicks }
  get xAxisGrads() { return this.#xAxisGrads }
  get scrollOffsetPx() { return this.core.scrollPos % this.candleW }
  get bufferPx() { return this.core.bufferPx }

  /**
 * return canvas x co-ordinate
 * handles X Axis modes: default, indexed
 * @param {number} ts - chart time stamp
 * @return {number}  
 * @memberof xAxis
 */
  xPos(ts) {
    return bRound((this.range.rangeIndex(ts) * this.candleW) + (this.candleW * 0.5))
  }

  t2Index(ts) {
    return this.range.rangeIndex(ts)
  }

  t2Pixel(ts) {
    return this.xPos(ts)
  }

  pixel2T(x) {
    let c = this.pixel2Index(x)
    return this.range.value(c)[0]
  }

  pixel2Index(x) {
    x -= this.candleW / 2
    let c = this.range.indexStart 
    let o = bRound(x / this.candleW)
    return c + o // - 1
  }

  pixelOHLCV(x) {
    let c = this.pixel2Index(x)
    return this.range.value(c)
  }

  xPosSnap2CandlePos(x) {
    let r = x % this.candleW
    let o = (r) ? this.candleW / 2 : 0
    return bRound((x - r) + o)
  }

  /**
   * return chart time
   * handles X Axis modes: default, indexed
   * @param {number} x
   * @returns {timestamp}
   * @memberof xAxis
   */
  xPos2Time(x) {
    return this.pixel2T(x)
  }

  xPos2Index(x) {
    return this.pixel2Index(x)
  }

  xPosOHLCV(x) {
    return this.pixelOHLCV(x)
  }

  initXAxisGrads() {
    this.#xAxisGrads = this.calcXAxisGrads()
  }

  calcXAxisGrads(range=this.range.snapshot()) {
    const grads = {
      entries: {},
      values: [],
      major: [],
      minor: [],
    }
    const units = ms2TimeUnits(range.rangeDuration)
    grads.units = units

    for (let u in units) {
      if (units[u] > 0) {
        grads.units = [u, u]
        grads.timeSpan = `${units[u]} ${u}`
        break
      }
    }
 
    const tf = range.interval
    const {xStep, rank} = this.xStep(range)
    const tLimit = this.pixel2T(this.width) + xStep

    let t1 = range.timeMin - (range.timeMin % xStep) - xStep
    let prev
    let start = t1

    while (t1 &lt; tLimit) {

      let y = time_start(t1, "years")
      let m = time_start(t1, "months")
      let d = time_start(t1, "days")

      if (!(y in grads.entries) &amp;&amp; y >= start) {
        grads.entries[y] = [this.dateTimeValue(y, tf), this.t2Pixel(y), y, "major"]
        prev = y
      }

      else if (!(m in grads.entries) &amp;&amp; m >= start) {
        grads.entries[m] = [this.dateTimeValue(m, tf), this.t2Pixel(m), m, "major"]
        prev = m
      }

      else if (!(d in grads.entries) &amp;&amp; d >= start) {
        grads.entries[d] = [this.dateTimeValue(d, tf), this.t2Pixel(d), d, "major"]
        prev = d
      }

      // else if (!(t1 in grads.entries)) {
        grads.entries[t1] = [this.dateTimeValue(t1, tf), this.t2Pixel(t1), t1, "minor"]
        prev = t1
      // }      

      t1 += xStep
    }

    grads.values = Object.values(grads.entries)

    return grads
  }

  xStep(range) {

    // minStep in pixels
    let minStep = XAXIS_STEP;
    let interval = this.#indexBased ? range.interval : 1
    let xStep = 0
    let candleW = bRound(this.width / range.Length)
    let rank

    let i = TIMESCALES.indexOf(interval)
    while (i-- >= 0) {

      const gradPixels = candleW * (TIMESCALES[i] / interval)
      
      if (gradPixels >= minStep) {
        xStep = TIMESCALES[i]
        rank = TIMESCALESRANK[i]
        return {xStep, rank}
      }
    }
  }

  dateTimeValue(ts, tf) {
    let value
    if ((ts / DAY_MS) % 1 === 0) {
      const date = get_day(ts)
      if (date === 1) {
        let month = get_month(ts)
        if (month === 0) return get_year(ts)
        else return get_monthName(ts)
      }
      else return date
    }
    else {
      // TODO: SECONDS_MS
      if (tf &lt; MINUTE_MS) return this.MS(ts)
      else if (tf &lt; HOUR_MS) return this.MS(ts)
      else return this.HM(ts)
    }
  }

  gradsWorker() {
    
  }

  HM(t) {
    let h = String(get_hour(t)).padStart(2, '0');
    let m = String(get_minute(t)).padStart(2, '0');
    return `${h}:${m}`
  }

  HMS(t) {
    let h = String(get_hour(t)).padStart(2, '0');
    let m = String(get_minute(t)).padStart(2, '0');
    let s = String(get_second(t)).padStart(2, '0');
    return `${h}:${m}:${s}`
  }

  MS(t) {
    let m = String(get_minute(t)).padStart(2, '0');
    let s = String(get_second(t)).padStart(2, '0');
    return `${m}:${s}`
  }

  doCalcXAxisGrads(range) {
    this.#xAxisGrads = this.calcXAxisGrads(range)
  }

}
</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Classes</h3><ul><li><a href="Axis.html">Axis</a></li><li><a href="Colour.html">Colour</a></li><li><a href="DMI.module.exports.html">module.exports</a></li><li><a href="EMA.module.exports.html">module.exports</a></li><li><a href="Hit.html">Hit</a></li><li><a href="indicator.html">indicator</a></li><li><a href="Layer.html">Layer</a></li><li><a href="MainPane.html">MainPane</a></li><li><a href="module.exports_module.exports.html">exports</a></li><li><a href="Node.html">Node</a></li><li><a href="RSI.html">RSI</a></li><li><a href="RSI.module.exports.html">module.exports</a></li><li><a href="ScaleBar.html">ScaleBar</a></li><li><a href="Scene.html">Scene</a></li><li><a href="StateMachine.html">StateMachine</a></li><li><a href="ToolsBar.html">ToolsBar</a></li><li><a href="TradeXchart.html">TradeXchart</a></li><li><a href="TradeXchart.module.exports.html">module.exports</a></li><li><a href="Viewport.html">Viewport</a></li><li><a href="WebWorker.html">WebWorker</a></li></ul><h3>Global</h3><ul><li><a href="global.html#addOffChart">addOffChart</a></li><li><a href="global.html#addTool">addTool</a></li><li><a href="global.html#binarySearch">binarySearch</a></li><li><a href="global.html#binarySearchNearest">binarySearchNearest</a></li><li><a href="global.html#bRound">bRound</a></li><li><a href="global.html#calcIndicator">calcIndicator</a></li><li><a href="global.html#calcIndicatorStream">calcIndicatorStream</a></li><li><a href="global.html#calcTextWidth">calcTextWidth</a></li><li><a href="global.html#calcTimeIndex">calcTimeIndex</a></li><li><a href="global.html#CandleType">CandleType</a></li><li><a href="global.html#CHART_MINH">CHART_MINH</a></li><li><a href="global.html#checkType">checkType</a></li><li><a href="global.html#copyDeep">copyDeep</a></li><li><a href="global.html#countDigits">countDigits</a></li><li><a href="global.html#createFont">createFont</a></li><li><a href="global.html#day_start">day_start</a></li><li><a href="global.html#debounce">debounce</a></li><li><a href="global.html#decimalPlaces">decimalPlaces</a></li><li><a href="global.html#destroy">destroy</a></li><li><a href="global.html#detectInterval">detectInterval</a></li><li><a href="global.html#draw">draw</a></li><li><a href="global.html#drawTextBG">drawTextBG</a></li><li><a href="global.html#emit">emit</a></li><li><a href="global.html#end">end</a></li><li><a href="global.html#execute">execute</a></li><li><a href="global.html#firstItemInMap">firstItemInMap</a></li><li><a href="global.html#float2Int">float2Int</a></li><li><a href="global.html#get_day">get_day</a></li><li><a href="global.html#get_month">get_month</a></li><li><a href="global.html#get_year">get_year</a></li><li><a href="global.html#getPixelRatio">getPixelRatio</a></li><li><a href="global.html#getPrecision">getPrecision</a></li><li><a href="global.html#getRandom">getRandom</a></li><li><a href="global.html#getRandomInt">getRandomInt</a></li><li><a href="global.html#getRandomIntBetween">getRandomIntBetween</a></li><li><a href="global.html#getRandomIntInclusive">getRandomIntInclusive</a></li><li><a href="global.html#getTextRectHeight">getTextRectHeight</a></li><li><a href="global.html#getTextRectWidth">getTextRectWidth</a></li><li><a href="global.html#hex">hex</a></li><li><a href="global.html#hexa">hexa</a></li><li><a href="global.html#id">id</a></li><li><a href="global.html#index10">index10</a></li><li><a href="global.html#insertAtIndex">insertAtIndex</a></li><li><a href="global.html#interval2MS">interval2MS</a></li><li><a href="global.html#isArray">isArray</a></li><li><a href="global.html#isBoolean">isBoolean</a></li><li><a href="global.html#isFunction">isFunction</a></li><li><a href="global.html#isNumber">isNumber</a></li><li><a href="global.html#isObject">isObject</a></li><li><a href="global.html#isString">isString</a></li><li><a href="global.html#isValid">isValid</a></li><li><a href="global.html#isValidCandle">isValidCandle</a></li><li><a href="global.html#limit">limit</a></li><li><a href="global.html#loadState">loadState</a></li><li><a href="global.html#log10">log10</a></li><li><a href="global.html#mean">mean</a></li><li><a href="global.html#mergeDeep">mergeDeep</a></li><li><a href="global.html#month_start">month_start</a></li><li><a href="global.html#ms2TimeUnits">ms2TimeUnits</a></li><li><a href="global.html#nearestArrayValue">nearestArrayValue</a></li><li><a href="global.html#nice">nice</a></li><li><a href="global.html#numDigits">numDigits</a></li><li><a href="global.html#numDigits2">numDigits2</a></li><li><a href="global.html#off">off</a></li><li><a href="global.html#on">on</a></li><li><a href="global.html#power">power</a></li><li><a href="global.html#precision">precision</a></li><li><a href="global.html#price2YPos">price2YPos</a></li><li><a href="global.html#refresh">refresh</a></li><li><a href="global.html#renderClosedFillPath">renderClosedFillPath</a></li><li><a href="global.html#renderClosedStrokePath">renderClosedStrokePath</a></li><li><a href="global.html#renderFilledCircle">renderFilledCircle</a></li><li><a href="global.html#renderFilledDiamond">renderFilledDiamond</a></li><li><a href="global.html#renderFilledTriangle">renderFilledTriangle</a></li><li><a href="global.html#renderFillRect">renderFillRect</a></li><li><a href="global.html#renderFillRoundRect">renderFillRoundRect</a></li><li><a href="global.html#renderHorizontalLine">renderHorizontalLine</a></li><li><a href="global.html#renderLine">renderLine</a></li><li><a href="global.html#renderPath">renderPath</a></li><li><a href="global.html#renderRoundRect">renderRoundRect</a></li><li><a href="global.html#renderStrokedCircle">renderStrokedCircle</a></li><li><a href="global.html#renderStrokeFillRoundRect">renderStrokeFillRoundRect</a></li><li><a href="global.html#renderStrokeRoundRect">renderStrokeRoundRect</a></li><li><a href="global.html#renderText">renderText</a></li><li><a href="global.html#renderVerticalLine">renderVerticalLine</a></li><li><a href="global.html#replacer">replacer</a></li><li><a href="global.html#resize">resize</a></li><li><a href="global.html#reviver">reviver</a></li><li><a href="global.html#round">round</a></li><li><a href="global.html#saveState">saveState</a></li><li><a href="global.html#setDimensions">setDimensions</a></li><li><a href="global.html#setHex">setHex</a></li><li><a href="global.html#setHSLA">setHSLA</a></li><li><a href="global.html#setPriceVolumePrecision">setPriceVolumePrecision</a></li><li><a href="global.html#setRGBA">setRGBA</a></li><li><a href="global.html#start">start</a></li><li><a href="global.html#stop">stop</a></li><li><a href="global.html#throttle">throttle</a></li><li><a href="global.html#time2XPos">time2XPos</a></li><li><a href="global.html#timestampDifference">timestampDifference</a></li><li><a href="global.html#updateLegends">updateLegends</a></li><li><a href="global.html#updateRange">updateRange</a></li><li><a href="global.html#validateConfig">validateConfig</a></li><li><a href="global.html#validateShallow">validateShallow</a></li><li><a href="global.html#value">value</a></li><li><a href="global.html#weave">weave</a></li><li><a href="global.html#YAxisPosition">YAxisPosition</a></li><li><a href="global.html#YAxisType">YAxisType</a></li><li><a href="global.html#year_start">year_start</a></li><li><a href="global.html#zoomRange">zoomRange</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc/jsdoc">JSDoc 3.6.11</a> on Sat Mar 11 2023 22:32:46 GMT+0100 (Central European Standard Time)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
