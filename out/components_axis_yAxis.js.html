<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: components/axis/yAxis.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: components/axis/yAxis.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>// yAxis.js

import Axis from "./axis";
import { bRound, limit, log10, power, precision, round } from "../../utils/number";
import { isNumber } from "../../utils/typeChecks";

import { 
  PRICEDIGITS, 
  YAXIS_STEP,
  YAXIS_GRID,
  YAXIS_TYPES
} from "../../definitions/chart";

export default class yAxis extends Axis {

  #source
  #parent
  #chart
  #core

  #yAxisType = YAXIS_TYPES[0]  // default, log, percent
  #mode = "automatic"
  #transform = {
    automatic: {
      get max() { return this.range?.valueMax },
      get min() { return this.range?.valueMin },
      get mid() { return this.range?.valueMin + (this.range?.valueDiff * 0.5) },
      get diff() { return this.range?.valueDiff },
      zoom: 1,
      offset: 0,
      range: null
    },
    manual: {
      max: 1,
      min: 0,
      mid: 0.5,
      diff: 1,
      zoom: 1,
      offset: 0
    }
  }
  #yAxisPadding = 1.04
  #yAxisStep = YAXIS_STEP
  // #yAxisGrid = YAXIS_GRID
  #yAxisDigits = PRICEDIGITS
  // #yAxisRound = 3
  #yAxisTicks = 3
  #yAxisGrads

  #range

  constructor(parent, chart, yAxisType=YAXIS_TYPES[0], range) {
    super(parent)
    this.#chart = chart
    this.#parent = parent
    this.#source = parent.parent
    this.yAxisType = yAxisType
    // this.#yAxisGrid = (this.core.config?.yAxisGrid) ? 
    //   this.core.config?.yAxisGrid : YAXIS_GRID

    range = (range) ? range : this.core.range
    this.#transform.automatic.range = range
    this.#range = new Proxy(range, {
      get: (obj, prop) => {
        const m = this.#mode
        const t = this.#transform
        switch (prop) {
          case "max": return t[m][prop] // "valueMax"
          case "min":  return t[m][prop] // "valueMin"
          case "mid": return t[m][prop] // "priceMid"
          case "diff": return t[m][prop] // "valueDiff"
          case "zoom": return t[m][prop]
          case "offset": return t[m][prop]
          default: return obj[prop]
        }
      }
    })
  }

  get chart() { return this.#chart }
  get height() { return this.chart.height }
  get rangeH() { return this.#range.diff * this.yAxisPadding }
  get yAxisRatio() { return this.getYAxisRatio() }
  get yAxisPrecision() { return this.yAxisCalcPrecision }
  set yAxisPadding(p) { this.#yAxisPadding = p }
  get yAxisPadding() { return this.#yAxisPadding }
  set yAxisType(t) { this.#yAxisType = YAXIS_TYPES.includes(t) ? t : YAXIS_TYPES[0] }
  get yAxisType() { return this.#yAxisType }
  set yAxisStep(s) { this.#yAxisStep = isNumber(s) ? s : YAXIS_STEP }
  get yAxisStep() { return this.#yAxisStep }
  set yAxisTicks(t) { this.#yAxisTicks = isNumber(t) ? t : 0 }
  get yAxisTicks() { return this.#yAxisTicks }
  get yAxisGrads() { return this.#yAxisGrads }
  set mode(m) { this.setMode(m) }
  get mode() { return this.#mode }
  set offset(o) { this.setOffset(o) }
  get offset() { return this.#range.offset }
  set zoom(z) { this.setZoom(z) }
  get zoom() { return this.#range.zoom }

  getYAxisRatio() {
    // const diff = (this.#mode == "automatic") ? this.#range.diff : this.#transform.diff
    return this.height / this.#range.diff
  }

  yAxisRangeBounds() {

  }

  yAxisLog() {
    
  }

  yAxisCntDigits(value) {
    return this.countDigits(value)
  }

  yAxisCalcPrecision() {
    let integerCnt = this.numDigits(this.#range.max)
    // let decimalCnt = this.precision(this.#range.max)
    return this.yDigits - integerCnt
  }

  yAxisCursor() {

  }

  /**
   * return canvas y co-ordinate
   * handles Y Axis modes: default, log, percentate
   * @param {number} yData - chart price or offchart indicator y data
   * @return {number}  
   * @memberof yAxis
   */
  yPos(yData) {
    switch(this.yAxisType) {
      case "percent" : return bRound(this.p100toPixel(yData))
      case "log" : return bRound(this.$2Pixel(log10(yData)))
      default : return bRound(this.$2Pixel(yData))
    }
  }

  /**
   * return chart price
   * handles Y Axis modes: default, log, percentate
   * @param {number} y
   * @return {number}
   * @memberof yAxis
   */
  yPos2Price(y) {
    return this.pixel2$(y)
  }

  $2Pixel(yData) {
    // const min = this.#range.min 
    const height = yData - this.#range.min
    const yPos = this.height - (height * this.yAxisRatio) + this.#range.offset
    return yPos
  }

  lastYData2Pixel(yData) {
    let height = yData - this.core.stream.lastPriceMin
    let yPos = this.height - (height * this.yAxisRatio)
    return yPos
  }

  pixel2$(y) {
    let ratio = (this.height - y) / this.height
    let adjust = this.#range.diff * ratio
    return this.#range.min + adjust
  }

  p100toPixel(yData) {
    return this.height * yData / 100
  }

  yAxisTransform() {

  }

  setMode(m) {
    if (!["automatic","manual"].includes(m)) return false

    const t = this.#transform
    if (this.mode == "automatic" &amp;&amp; m == "manual") {
      t.manual.zoom = 0
      t.manual.max = this.#range.valueMax
      t.manual.min = this.#range.valueMin
      this.#mode = m
    }
    else if (this.mode == "manual" &amp;&amp; m == "automatic") {
      t.manual.zoom = 0
      this.#mode = m
    }
  }

  setOffset(o) {
    if (!isNumber(o) || this.#mode !== "manual") return false

    const t = this.#transform
    t.manual.offset += o
    console.log("t.manual.offset:",t.manual.offset)
  }

  setZoom(z) {
    if (!isNumber(z) || this.#mode !== "manual") return false

    const t = this.#transform
    t.manual.zoom += z
    // console.log(JSON.stringify(t.manual))

    const r = z / this.height
    const min = t.manual.min * (1 - r)
    const max = t.manual.max * (1 + r)
    
    if (max &lt; min) return

    t.manual.max =  max
    t.manual.min = (min >= 0)? min : 0
    t.manual.mid = (max - min) / 2
    t.manual.diff = max - min
    t.manual.zoom = 1
    t.manual.offset = 0

    // console.log(JSON.stringify(t.manual))
  }

//   setYFactor(f) {
//     if (!isNumber(f) || this.#mode !== "manual") return false
//     this.#transform.factor += f * -1
//     console.log(`this.#transform.factor`,this.#transform.factor)
//   }
  
//   calc_zoom(event) {
//     let d = this.drug.y - event.center.y
//     let speed = d > 0 ? 3 : 1
//     let k = 1 + speed * d / this.layout.height
//     return Utils.clamp(this.drug.z * k, 0.005, 100)
// }

  calcGradations() {

    switch (this.yAxisType) {
      case "percent":
        this.#yAxisGrads = this.gradations(100, 0, false, true)
        break;
      default:
        let max = (this.#range.max > 0) ? this.#range.max : 1
        let min = (this.#range.min > 0) ? this.#range.min : 0
        this.#yAxisGrads = this.gradations(max, min)
        break;
    }
  }

  gradations(max, min, decimals=true, fixed=false) {

      let digits,
          rangeH,
          yGridSize;
    const scaleGrads = [];

    // max = this.#range.max
    // min = this.#range.min

    // this.#yAxisRound = this.countDigits(this.#range.diff).integers

    // roughly divide the yRange into cells
    rangeH = max - min
    rangeH = (this.rangeH > 0) ? this.rangeH : 1
    yGridSize = (rangeH)/(this.height / (this.core.theme.yAxis.fontSize * 1.75));


    // if (fixed)

    // if (fixed) {
    //   // const rangeMid = (max + min) * 0.5
    //   // const midH = this.height * 0.5
    //   // digits = this.countDigits(rangeMid)
    //   // const scaleMid = this.niceValue(digits, decimals)
  
    //   // scaleGrads.push([scaleMid, round(midH), digits])
  
    //   // let grad = round(power(log10(midH), 2) - 1),
    //   //     step$ = (max - scaleMid) / grad,
    //   //     stepP = midH / grad,
    //   //     upper = scaleMid + step$,
    //   //     pos = midH - stepP,
    //   //     nice, 
    //   //     entry;
    //   // while (upper &lt;= max) {
    //   //   digits = this.countDigits(upper)
    //   //   nice = this.niceValue(digits, decimals)
    //   //   entry = [nice, round(pos), digits]
    //   //   scaleGrads.unshift(entry)
    //   //   upper += step$
    //   //   pos -= stepP
    //   // }
    //   // let lower = scaleMid - step$
    //   //     pos = midH + stepP
    //   // while (lower >= min) {
    //   //   digits = this.countDigits(lower)
    //   //   nice = this.niceValue(digits, decimals)
    //   //   entry = [nice, round(pos), digits]
    //   //   scaleGrads.push(entry)
    //   //   lower -= step$
    //   //   pos += stepP
    //   // }

    //   // roughly divide the yRange into cells
    //   rangeH = (this.rangeH > 0) ? this.rangeH : 1
    //   yGridSize = (rangeH)/this.#yAxisGrid;
    // }
    // else {
    //   // roughly divide the yRange into cells
    //   rangeH = (this.rangeH > 0) ? this.rangeH : 1
    //   yGridSize = (rangeH)/this.#yAxisGrid;


    // }

    // try to find a nice number to round to
    let niceNumber = Math.pow( 10 , Math.ceil( Math.log10( yGridSize ) ) );
    if ( yGridSize &lt; 0.25 * niceNumber ) niceNumber = 0.25 * niceNumber;
    else if ( yGridSize &lt; 0.5 * niceNumber ) niceNumber = 0.5 * niceNumber;

    // find next largest nice number above yStart
    var yStartRoundNumber = Math.ceil( min/niceNumber ) * niceNumber;
    // find next lowest nice number below yEnd
    var yEndRoundNumber = Math.floor( max/niceNumber ) * niceNumber;

    let pos = this.height,
        step$ = (yEndRoundNumber - yStartRoundNumber) / niceNumber,
        stepP = this.height / step$,
        step = this.countDigits(step$),
        nice;

    for ( var y = yStartRoundNumber ; y &lt;= yEndRoundNumber ; y += niceNumber )
    {
      digits = this.countDigits(y)
      nice = this.niceValue(digits, decimals, step)
      scaleGrads.push([nice, round(pos), digits])

      pos -= stepP
    }
    scaleGrads.shift()
    scaleGrads.pop()

    return scaleGrads
  }

  niceValue(digits, decimals=true, step) {
    if (digits.integers) {
      let x = step.integers
      if (x - 2 > 0) {
        let factor = power(10, x - 2)
        return Math.floor(digits.value / factor) * factor
      }
      else {
        if (!decimals) return Math.floor(digits.value)
        x = (x > 0)? x : x * -1
        return round(digits.value, x)
      }
    }
    else {
      let y = digits.decimals - step.decimals
      y = (y > 0)? y : y * -1
      return round(digits.value, y)
    }
  }

  limitPrecision(digits) {
    let value = digits.value,
        cnt = this.#yAxisDigits - digits.total,
        cnt2 = 4 - digits.integers

    if (cnt &lt; 1) {
      let decimals = limit(digits.decimals + cnt, 0, 100)
      value = Number.parseFloat(value).toFixed(decimals)
    }
    else if (cnt2 &lt; 1) {
      let decimals = 2 - cnt2
      value = Number.parseFloat(value).toFixed(decimals)
    }

    return value
  }

}
</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Classes</h3><ul><li><a href="Axis.html">Axis</a></li><li><a href="Colour.html">Colour</a></li><li><a href="DMI.module.exports.html">module.exports</a></li><li><a href="EMA.module.exports.html">module.exports</a></li><li><a href="Hit.html">Hit</a></li><li><a href="indicator.html">indicator</a></li><li><a href="Layer.html">Layer</a></li><li><a href="MainPane.html">MainPane</a></li><li><a href="module.exports_module.exports.html">exports</a></li><li><a href="Node.html">Node</a></li><li><a href="RSI.html">RSI</a></li><li><a href="RSI.module.exports.html">module.exports</a></li><li><a href="ScaleBar.html">ScaleBar</a></li><li><a href="Scene.html">Scene</a></li><li><a href="StateMachine.html">StateMachine</a></li><li><a href="ToolsBar.html">ToolsBar</a></li><li><a href="TradeXchart.html">TradeXchart</a></li><li><a href="TradeXchart.module.exports.html">module.exports</a></li><li><a href="Viewport.html">Viewport</a></li><li><a href="WebWorker.html">WebWorker</a></li></ul><h3>Global</h3><ul><li><a href="global.html#addOffChart">addOffChart</a></li><li><a href="global.html#addTool">addTool</a></li><li><a href="global.html#binarySearch">binarySearch</a></li><li><a href="global.html#binarySearchNearest">binarySearchNearest</a></li><li><a href="global.html#bRound">bRound</a></li><li><a href="global.html#calcIndicator">calcIndicator</a></li><li><a href="global.html#calcIndicatorStream">calcIndicatorStream</a></li><li><a href="global.html#calcTextWidth">calcTextWidth</a></li><li><a href="global.html#calcTimeIndex">calcTimeIndex</a></li><li><a href="global.html#CandleType">CandleType</a></li><li><a href="global.html#CHART_MINH">CHART_MINH</a></li><li><a href="global.html#checkType">checkType</a></li><li><a href="global.html#copyDeep">copyDeep</a></li><li><a href="global.html#countDigits">countDigits</a></li><li><a href="global.html#createFont">createFont</a></li><li><a href="global.html#day_start">day_start</a></li><li><a href="global.html#debounce">debounce</a></li><li><a href="global.html#decimalPlaces">decimalPlaces</a></li><li><a href="global.html#destroy">destroy</a></li><li><a href="global.html#detectInterval">detectInterval</a></li><li><a href="global.html#draw">draw</a></li><li><a href="global.html#drawTextBG">drawTextBG</a></li><li><a href="global.html#emit">emit</a></li><li><a href="global.html#end">end</a></li><li><a href="global.html#execute">execute</a></li><li><a href="global.html#firstItemInMap">firstItemInMap</a></li><li><a href="global.html#float2Int">float2Int</a></li><li><a href="global.html#get_day">get_day</a></li><li><a href="global.html#get_month">get_month</a></li><li><a href="global.html#get_year">get_year</a></li><li><a href="global.html#getPixelRatio">getPixelRatio</a></li><li><a href="global.html#getPrecision">getPrecision</a></li><li><a href="global.html#getRandom">getRandom</a></li><li><a href="global.html#getRandomInt">getRandomInt</a></li><li><a href="global.html#getRandomIntBetween">getRandomIntBetween</a></li><li><a href="global.html#getRandomIntInclusive">getRandomIntInclusive</a></li><li><a href="global.html#getTextRectHeight">getTextRectHeight</a></li><li><a href="global.html#getTextRectWidth">getTextRectWidth</a></li><li><a href="global.html#hex">hex</a></li><li><a href="global.html#hexa">hexa</a></li><li><a href="global.html#id">id</a></li><li><a href="global.html#index10">index10</a></li><li><a href="global.html#insertAtIndex">insertAtIndex</a></li><li><a href="global.html#interval2MS">interval2MS</a></li><li><a href="global.html#isArray">isArray</a></li><li><a href="global.html#isBoolean">isBoolean</a></li><li><a href="global.html#isFunction">isFunction</a></li><li><a href="global.html#isNumber">isNumber</a></li><li><a href="global.html#isObject">isObject</a></li><li><a href="global.html#isString">isString</a></li><li><a href="global.html#isValid">isValid</a></li><li><a href="global.html#isValidCandle">isValidCandle</a></li><li><a href="global.html#limit">limit</a></li><li><a href="global.html#loadState">loadState</a></li><li><a href="global.html#log10">log10</a></li><li><a href="global.html#mean">mean</a></li><li><a href="global.html#mergeDeep">mergeDeep</a></li><li><a href="global.html#month_start">month_start</a></li><li><a href="global.html#ms2TimeUnits">ms2TimeUnits</a></li><li><a href="global.html#nearestArrayValue">nearestArrayValue</a></li><li><a href="global.html#nice">nice</a></li><li><a href="global.html#numDigits">numDigits</a></li><li><a href="global.html#numDigits2">numDigits2</a></li><li><a href="global.html#off">off</a></li><li><a href="global.html#on">on</a></li><li><a href="global.html#power">power</a></li><li><a href="global.html#precision">precision</a></li><li><a href="global.html#price2YPos">price2YPos</a></li><li><a href="global.html#refresh">refresh</a></li><li><a href="global.html#renderClosedFillPath">renderClosedFillPath</a></li><li><a href="global.html#renderClosedStrokePath">renderClosedStrokePath</a></li><li><a href="global.html#renderFilledCircle">renderFilledCircle</a></li><li><a href="global.html#renderFilledDiamond">renderFilledDiamond</a></li><li><a href="global.html#renderFilledTriangle">renderFilledTriangle</a></li><li><a href="global.html#renderFillRect">renderFillRect</a></li><li><a href="global.html#renderFillRoundRect">renderFillRoundRect</a></li><li><a href="global.html#renderHorizontalLine">renderHorizontalLine</a></li><li><a href="global.html#renderLine">renderLine</a></li><li><a href="global.html#renderPath">renderPath</a></li><li><a href="global.html#renderRoundRect">renderRoundRect</a></li><li><a href="global.html#renderStrokedCircle">renderStrokedCircle</a></li><li><a href="global.html#renderStrokeFillRoundRect">renderStrokeFillRoundRect</a></li><li><a href="global.html#renderStrokeRoundRect">renderStrokeRoundRect</a></li><li><a href="global.html#renderText">renderText</a></li><li><a href="global.html#renderVerticalLine">renderVerticalLine</a></li><li><a href="global.html#replacer">replacer</a></li><li><a href="global.html#resize">resize</a></li><li><a href="global.html#reviver">reviver</a></li><li><a href="global.html#round">round</a></li><li><a href="global.html#saveState">saveState</a></li><li><a href="global.html#setDimensions">setDimensions</a></li><li><a href="global.html#setHex">setHex</a></li><li><a href="global.html#setHSLA">setHSLA</a></li><li><a href="global.html#setPriceVolumePrecision">setPriceVolumePrecision</a></li><li><a href="global.html#setRGBA">setRGBA</a></li><li><a href="global.html#start">start</a></li><li><a href="global.html#stop">stop</a></li><li><a href="global.html#throttle">throttle</a></li><li><a href="global.html#time2XPos">time2XPos</a></li><li><a href="global.html#timestampDifference">timestampDifference</a></li><li><a href="global.html#updateLegends">updateLegends</a></li><li><a href="global.html#updateRange">updateRange</a></li><li><a href="global.html#validateConfig">validateConfig</a></li><li><a href="global.html#validateShallow">validateShallow</a></li><li><a href="global.html#value">value</a></li><li><a href="global.html#weave">weave</a></li><li><a href="global.html#YAxisPosition">YAxisPosition</a></li><li><a href="global.html#YAxisType">YAxisType</a></li><li><a href="global.html#year_start">year_start</a></li><li><a href="global.html#zoomRange">zoomRange</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc/jsdoc">JSDoc 3.6.11</a> on Sat Mar 11 2023 22:32:46 GMT+0100 (Central European Standard Time)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
